/**
 * Game Gateway â€” Organic MICA Game Integration
 * "Â¿Juegas?" â€” Conversational onboarding to games
 * Generated by Kimi K2.5, refined by Antigravity
 */
(function() {
  'use strict';

  // ============================================================
  // CONFIG
  // ============================================================
  const CONFIG = {
    trigger: {
      scrollThreshold: 0.6,
      timeThreshold: 45000,
      maxShowsPerSession: 2
    },
    games: [
      { id: 'memory', name: 'Memory', icon: 'ðŸ§ ', tags: ['calm', 'art'] },
      { id: 'puzzle', name: 'Puzzle', icon: 'ðŸ§©', tags: ['calm', 'art'] },
      { id: 'snake', name: 'Snake', icon: 'ðŸ', tags: ['action'] },
      { id: 'breakout', name: 'Breakout', icon: 'ðŸ§±', tags: ['action'] },
      { id: 'tetris', name: 'Tetris', icon: 'ðŸ•¹ï¸', tags: ['action', 'classic'] },
      { id: 'whack', name: 'Whack Art', icon: 'ðŸ”¨', tags: ['action', 'fun'] },
      { id: 'simon', name: 'Simon', icon: 'ðŸŽµ', tags: ['memory'] },
      { id: 'quiz', name: 'Quiz', icon: 'â“', tags: ['trivia', 'art'] },
      { id: 'catch', name: 'Catch', icon: 'ðŸ§º', tags: ['action'] },
      { id: 'collage', name: 'Collage', icon: 'ðŸŽ¨', tags: ['creative', 'art'] },
      { id: 'reinas', name: 'Reinas', icon: 'ðŸ‘‘', tags: ['trivia'] },
      { id: 'kintsugi', name: 'Kintsugi', icon: 'ðŸ¥‡', tags: ['zen', 'art'] },
      { id: 'pong', name: 'Pong', icon: 'ðŸ“', tags: ['action', 'classic'] },
      { id: 'reaction', name: 'Reflejos', icon: 'âš¡', tags: ['action'] },
      { id: 'typing', name: 'Typing', icon: 'âŒ¨ï¸', tags: ['skill'] },
      { id: 'chess', name: 'Ajedrez', icon: 'â™Ÿï¸', tags: ['strategy'] },
      { id: 'checkers', name: 'Damas', icon: 'ðŸ”´', tags: ['strategy'] },
      { id: 'connect4', name: 'Conecta 4', icon: 'ðŸ”µ', tags: ['strategy'] },
      { id: 'reversi', name: 'Reversi', icon: 'âš«', tags: ['strategy'] },
      { id: 'restaurador', name: 'Restaurador', icon: 'ðŸŽ¨ðŸ’€', tags: ['fun', 'art'] },
      { id: 'runner', name: 'Runner', icon: 'ðŸƒ', tags: ['action'] },
      { id: 'rotate', name: 'Rotate', icon: 'ðŸ”„', tags: ['calm'] },
      { id: 'scratch', name: 'Scratch', icon: 'ðŸŽ°', tags: ['fun'] },
      { id: 'target', name: 'Target', icon: 'ðŸŽ¯', tags: ['action'] },
      { id: 'juego', name: 'Oca', icon: 'ðŸŽ²', tags: ['classic'] },
      { id: 'mica', name: 'MICA Viva', icon: 'âœ¨', tags: ['art', 'zen'] }
    ],
    quotes: {
      yes: [
        'Â¡AsÃ­ me gusta! Vamos a jugar... ðŸŽ®',
        'Excelente elecciÃ³n. Tu cerebro te lo agradecerÃ¡ ðŸ§ âœ¨',
        'Â¡Dale! He preparado algo especial para ti...',
        'MICA aprueba. Iniciando diversiÃ³n artÃ­stica... ðŸŽ¨'
      ],
      depends: [
        'Mmm, indecisiÃ³n... Te muestro opciones para tentarte ðŸ˜',
        'DÃ©jame recomendarte algo basado en lo que has visto...',
        '"Depende" es la respuesta de quien ya quiere jugar ðŸ˜‰',
        'Te voy a convencer. Mira esto...'
      ],
      no: [
        'Respeto tu decisiÃ³n... pero volverÃ© ðŸ˜ˆ',
        'Ok ok, sigue explorando. Pero los juegos te esperan ðŸŽ®',
        'Bueno... mÃ¡s arte para ti entonces. Â¡Excelente gusto! ðŸ–¼ï¸',
        'Â¿Seguro? Los cuadros se aburren sin ti... ðŸ˜¢',
        'Entendido. MICA se retira... por ahora ðŸ‘€'
      ]
    }
  };

  // ============================================================
  // STATE
  // ============================================================
  let state = {
    shown: false,
    showCount: 0,
    scrollTriggered: false,
    timeTriggered: false,
    dismissed: sessionStorage.getItem('gg-dismissed') === 'true'
  };

  // ============================================================
  // UTILITIES
  // ============================================================
  const utils = {
    random: arr => arr[Math.floor(Math.random() * arr.length)],
    
    throttle: (fn, wait) => {
      let last = 0;
      return (...args) => {
        const now = Date.now();
        if (now - last >= wait) { last = now; fn(...args); }
      };
    },

    getViewedArtworks: () => {
      try { return JSON.parse(localStorage.getItem('naroa-viewed') || '[]'); }
      catch { return []; }
    },

    saveViewedArtwork: (id) => {
      const viewed = utils.getViewedArtworks();
      if (!viewed.includes(id)) {
        viewed.push(id);
        localStorage.setItem('naroa-viewed', JSON.stringify(viewed.slice(-50)));
      }
    },

    trackInteraction: (action) => {
      if (window.gtag) window.gtag('event', 'game_gateway', { action });
    }
  };

  // ============================================================
  // STYLES
  // ============================================================
  function injectStyles() {
    if (document.getElementById('game-gateway-styles')) return;
    const style = document.createElement('style');
    style.id = 'game-gateway-styles';
    style.textContent = `
      .gg-overlay {
        position: fixed; inset: 0; z-index: 9999;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none;
        transition: opacity 0.5s ease;
      }
      .gg-overlay.active { opacity: 1; pointer-events: all; }

      .gg-backdrop {
        position: absolute; inset: 0;
        background: rgba(5, 5, 16, 0.85);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
      }

      .gg-dialog {
        position: relative; z-index: 1;
        background: rgba(20, 20, 40, 0.9);
        border: 1px solid rgba(204, 255, 0, 0.2);
        border-radius: 20px;
        padding: 40px;
        max-width: 480px;
        width: 90%;
        text-align: center;
        box-shadow: 0 0 60px rgba(204, 255, 0, 0.08), 0 25px 50px rgba(0,0,0,0.5);
        animation: ggSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes ggSlideIn {
        from { transform: translateY(30px) scale(0.95); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
      }

      .gg-avatar {
        width: 60px; height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ccff00, #00ff88);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.8rem;
        margin: 0 auto 15px;
        box-shadow: 0 0 25px rgba(204, 255, 0, 0.3);
        animation: ggBreathe 3s ease-in-out infinite;
      }

      @keyframes ggBreathe {
        0%, 100% { box-shadow: 0 0 25px rgba(204, 255, 0, 0.3); }
        50% { box-shadow: 0 0 40px rgba(204, 255, 0, 0.5); }
      }

      .gg-label {
        font-size: 0.75rem;
        color: rgba(204, 255, 0, 0.5);
        text-transform: uppercase;
        letter-spacing: 3px;
        margin-bottom: 10px;
      }

      .gg-text {
        font-size: 2rem;
        color: #fff;
        font-weight: 700;
        min-height: 50px;
        margin-bottom: 25px;
      }

      .gg-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .gg-btn {
        padding: 12px 28px;
        border-radius: 12px;
        font-family: 'Satoshi', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
      }

      .gg-btn::before {
        content: '';
        position: absolute; inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
        opacity: 0;
        transition: opacity 0.3s;
      }
      .gg-btn:hover::before { opacity: 1; }

      .gg-btn--yes {
        background: linear-gradient(135deg, #ccff00, #88dd00);
        color: #0a0a0a;
        box-shadow: 0 0 20px rgba(204, 255, 0, 0.3);
      }
      .gg-btn--yes:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 0 35px rgba(204, 255, 0, 0.5);
      }

      .gg-btn--depends {
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.2);
      }
      .gg-btn--depends:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }

      .gg-btn--no {
        background: transparent;
        color: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .gg-btn--no:hover {
        color: #ff003c;
        border-color: rgba(255, 0, 60, 0.3);
      }

      .gg-close {
        position: absolute;
        top: 12px; right: 12px;
        width: 32px; height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        color: rgba(255, 255, 255, 0.3);
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; justify-content: center;
      }
      .gg-close:hover { background: rgba(255, 0, 60, 0.2); color: #ff003c; }

      .gg-recs {
        display: none;
        margin-top: 20px;
      }
      .gg-recs.active { display: block; }

      .gg-rec-list {
        display: flex; gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .gg-game-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(204, 255, 0, 0.15);
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
        text-align: center;
      }
      .gg-game-card:hover {
        background: rgba(204, 255, 0, 0.1);
        border-color: rgba(204, 255, 0, 0.4);
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(204, 255, 0, 0.15);
      }
      .gg-game-card__icon { font-size: 2rem; margin-bottom: 5px; }
      .gg-game-card__name { font-size: 0.85rem; color: #fff; }

      .gg-response {
        color: #ccff00;
        font-style: italic;
        min-height: 24px;
        margin-top: 10px;
        font-size: 0.9rem;
      }
    `;
    document.head.appendChild(style);
  }

  // ============================================================
  // TYPEWRITER
  // ============================================================
  function typewriter(el, text, speed = 60) {
    el.textContent = '';
    let i = 0;
    const type = () => {
      if (i < text.length) {
        el.textContent += text[i++];
        setTimeout(type, speed);
      }
    };
    type();
  }

  // ============================================================
  // CREATE OVERLAY
  // ============================================================
  function createOverlay() {
    injectStyles();

    const overlay = document.createElement('div');
    overlay.className = 'gg-overlay';
    overlay.innerHTML = `
      <div class="gg-backdrop"></div>
      <div class="gg-dialog" id="gg-dialog">
        <button class="gg-close" aria-label="Cerrar">âœ•</button>
        <div class="gg-avatar">ðŸŽ­</div>
        <div class="gg-label">MICA te pregunta</div>
        <div class="gg-text" id="gg-mica-text"></div>
        <div class="gg-buttons">
          <button class="gg-btn gg-btn--yes" data-action="yes">ðŸŽ® Â¡SÃ­!</button>
          <button class="gg-btn gg-btn--depends" data-action="depends">ðŸ¤” Depende</button>
          <button class="gg-btn gg-btn--no" data-action="no">ðŸ˜´ Mejor no</button>
        </div>
        <div class="gg-response" id="gg-response"></div>
        <div class="gg-recs" id="gg-recommendations">
          <div class="gg-rec-list" id="gg-rec-list"></div>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);
    return overlay;
  }

  // ============================================================
  // RECOMMENDATIONS
  // ============================================================
  function getRecommendations(count = 3) {
    const viewed = utils.getViewedArtworks();
    let preferred = [];

    if (viewed.length > 5) {
      preferred = CONFIG.games.filter(g => g.tags.includes('art'));
    } else if (viewed.length > 0) {
      preferred = CONFIG.games.filter(g => g.tags.includes('calm') || g.tags.includes('art'));
    }

    if (preferred.length < count) {
      preferred = [...CONFIG.games];
    }

    // Shuffle and pick
    const shuffled = preferred.sort(() => Math.random() - 0.5);
    return shuffled.slice(0, count);
  }

  // ============================================================
  // ACTIONS
  // ============================================================
  function handleButtonClick(e, action, overlay) {
    const responseEl = overlay.querySelector('#gg-response');
    const recsEl = overlay.querySelector('#gg-recommendations');
    const quote = utils.random(CONFIG.quotes[action] || CONFIG.quotes.no);

    typewriter(responseEl, quote, 40);
    utils.trackInteraction(action);

    if (action === 'yes') {
      // Random game launch
      setTimeout(() => {
        const game = utils.random(CONFIG.games);
        launchGame(game);
        hide();
      }, 1500);
    } else if (action === 'depends') {
      // Show recommendations
      setTimeout(() => {
        const recs = getRecommendations(3);
        const listEl = overlay.querySelector('#gg-rec-list');
        listEl.innerHTML = recs.map(g => `
          <div class="gg-game-card" data-game-id="${g.id}">
            <div class="gg-game-card__icon">${g.icon}</div>
            <div class="gg-game-card__name">${g.name}</div>
          </div>
        `).join('');

        listEl.querySelectorAll('.gg-game-card').forEach(card => {
          card.addEventListener('click', () => {
            const game = CONFIG.games.find(g => g.id === card.dataset.gameId);
            if (game) { launchGame(game); hide(); }
          });
        });

        recsEl.classList.add('active');
      }, 800);
    } else {
      // No â€” dismiss
      setTimeout(() => {
        hide();
        sessionStorage.setItem('gg-dismissed', 'true');
        state.dismissed = true;
      }, 2000);
    }
  }

  function launchGame(game) {
    window.location.hash = `/${game.id}`;
    utils.trackInteraction(`launch_${game.id}`);
  }

  // ============================================================
  // TRIGGERS
  // ============================================================
  function setupTriggers() {
    if (state.dismissed) return;

    const handleScroll = utils.throttle(() => {
      if (state.scrollTriggered || state.shown || state.dismissed) return;
      const scrollPercent = window.scrollY / (document.body.scrollHeight - window.innerHeight);
      if (scrollPercent >= CONFIG.trigger.scrollThreshold) {
        state.scrollTriggered = true;
        show();
      }
    }, 200);

    setTimeout(() => {
      if (!state.timeTriggered && !state.shown && !state.dismissed) {
        state.timeTriggered = true;
        show();
      }
    }, CONFIG.trigger.timeThreshold);

    window.addEventListener('scroll', handleScroll, { passive: true });
  }

  // ============================================================
  // PUBLIC API
  // ============================================================
  let overlay = null;

  function init() {
    if (overlay) return;
    setupTriggers();

    // Track artwork views via IntersectionObserver
    document.querySelectorAll('[data-artwork]').forEach(el => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) utils.saveViewedArtwork(el.dataset.artwork);
        });
      }, { threshold: 0.5 });
      observer.observe(el);
    });
  }

  function show() {
    if (state.dismissed) return;
    if (state.shown) return;
    if (state.showCount >= CONFIG.trigger.maxShowsPerSession) return;

    if (!overlay) overlay = createOverlay();

    state.shown = true;
    state.showCount++;

    overlay.classList.add('active');

    // Wire up buttons
    overlay.querySelectorAll('.gg-btn').forEach(btn => {
      btn.onclick = (e) => handleButtonClick(e, btn.dataset.action, overlay);
    });

    overlay.querySelector('.gg-close').onclick = hide;
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay || e.target.classList.contains('gg-backdrop')) hide();
    });

    // Keyboard
    const escHandler = (e) => { if (e.key === 'Escape') hide(); };
    document.addEventListener('keydown', escHandler);

    // Typewriter intro
    const textEl = overlay.querySelector('#gg-mica-text');
    const responseEl = overlay.querySelector('#gg-response');
    const recsEl = overlay.querySelector('#gg-recommendations');
    responseEl.textContent = '';
    recsEl.classList.remove('active');
    typewriter(textEl, 'Â¿Juegas?', 80);

    utils.trackInteraction('show');
  }

  function hide() {
    if (!overlay || !state.shown) return;
    state.shown = false;
    overlay.classList.remove('active');
    setTimeout(() => {
      if (overlay) {
        const textEl = overlay.querySelector('#gg-mica-text');
        if (textEl) textEl.textContent = '';
      }
    }, 500);
  }

  window.GameGateway = {
    init,
    show,
    hide,
    getState: () => ({ ...state }),
    version: '2.0.0-mica'
  };

  // Auto-init
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
